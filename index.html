<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<script type="text/javascript" src="lib/lazyload.min.js"></script>
<script type="text/javascript">
    "use strict";


    LazyLoad.js([
        "lib/jquery.min.js",
        "lib/lodash.min.js",
        "util.js",
        "lib/slim.min.js",
        "lib/modernizr.min.js",
        "lib/pnotify.custom.min.js",
        'lib/dat.gui.min.js',
        "lib/eventemitter3.min.js",
        "lib/packery.pkgd.min.js"
        ], () => {

        LazyLoad.js([

            "graph.js",
            "netention.js",
            "memory.pouchdb.js",
            "memory.spimedb.js",
            "list.js",
            "map2d.js",
            "map3d.js",
            "spacegraph.js"], () => {

            $('#loading').hide();


            const I = window.I = new NClient({
//                network: [
//                    "localhost:8081"
//                ],
                //"ServerType": "0",
                //  0 = Global (node + full network)
                //  1 = Mirror (support global network),
                //  2 = Independent (node only, no network),

                //server.privacy = {
                //  "AllowAnonymousLogin": true,
                //  "MinPrivacyLevel", "MaxPrivacyLevel" // 0 = Global (all nodes), 1 = Public (node only), 2 = Friends/Groups only, 3 = Self only
                //}

                view: [
                    {
                        //var mapBtn = $('<div id="map" class="nt-btn nt-view-btn" title="Map / 3D Globe (geolocation)"><i class="fa fa-2x fa-map-marker"></i><span class="visuallyhidden">Map</span></div>').appendTo(viewMenu);
                        "I": "map3D",
                        "N": "3D Earth",
                        "_": "Cesium.js",
                        "icon": "fa-map-marker"
                    },
                    {
                        //var feedBtn = $('<div id="feed" class="nt-btn nt-view-btn" title="Feed (list)"><i class="fa fa-2x fa-th-list"></i><span class="visuallyhidden">Feed</span></div>').appendTo(viewMenu);
                        "I": "list",
                        "N": "List",
                        "icon": "fa-th-list"
                    }
                ],

                // PRIVACY
                privacy: {
                    // 0 = Global (all nodes), 1 = Public (node only), 2 = Friends/Groups only, 3 = Self only
                    'levelDefault': 1
                },
                memory: {
                    'durationDefault': Infinity,
                    // determine the default license for posted Nobjects
                    //"this message should be destructed at"
                    //"5 minutes"
                    //"10 days"
                    'license': "AGPL"
                    //'Creative
                },

                // VIEWS
                "IncludeFeed": true,
                "IncludeGraph": true,
                "IncludeMap": true,
                "IncludeTimeline": true,
                // USERS
                "AllowUserHomepage": true,
                "AllowInstantMessaging": true,
                "AllowVoice": true,
                "AllowVideo": true,
                // ADDONS
                "DefaultTheme": "dark", // Options: "dark" or "light"
                "AllowThemes": true,
                "AllowPlugins": true
            });


            // Set Theme
            $('body').addClass(I.DefaultTheme);

            $('#nt-user').on('click', function () {
                var mn = $('nav.right');
                if (mn.hasClass('visible')) {
                    mn.removeClass('visible');
                    $(this).removeClass('active');
                } else {
                    mn.addClass('visible');
                    $(this).addClass('active');
                }
            });

            $('.sub-menu ul').hide();
            $(".sub-menu a").click(function () {
                if ($(this).parent(".sub-menu").children("ul").is(":visible")) {
                    $(this).parent(".sub-menu").children("ul").hide();
                    $(this).find(".right").removeClass("fa-caret-down").addClass("fa-caret-up");
                } else {
                    $(this).parent(".sub-menu").children("ul").show();
                    $(this).find(".right").removeClass("fa-caret-up").addClass("fa-caret-down");
                }
            });

            var viewMenu = $('#nt-view-menu').find('.nt-btn-grp');
            var rightMenu = $('#nt-ri').find('.nt-btn-grp');

            // FEED
            if (I.IncludeFeed === true) {
                var feedBtn = $('<div id="feed" class="nt-btn nt-view-btn" title="Feed (list)"><i class="fa fa-2x fa-th-list"></i><span class="visuallyhidden">Feed</span></div>').prependTo(viewMenu);
            }


            // GRAPH
            if (I.IncludeGraph === true) {
                var graphBtn = $('<div id="graph" class="nt-btn nt-view-btn" title="Graph (relationship mapping)"><i class="fa fa-2x fa-code-fork"></i><span class="visuallyhidden">Graph</span></div>').prependTo(viewMenu);
            }

            // TIMELINE
            if (I.IncludeTimeline === true) {
                var timelineBtn = $('<div id="timeline" class="nt-btn nt-view-btn" title="Timeline (chronological)"><i class="fa fa-2x fa-clock-o"></i><span class="visuallyhidden">Timeline</span></div>').prependTo(viewMenu);
            }

            if (I.AllowInstantMessaging === true) {
                var messageBtn = $('<div id="notifications" class="nt-btn nt-view-btn" title="Updates (notifications / messages)"><i class="fa fa-2x fa-comments-o"></i><span class="visuallyhidden">Messages</span><span class="badge right">12</span></div>').prependTo(rightMenu);
            }

            if (I.AllowUserHomepage === true) {
                var messageBtn = $('<div id="home" class="nt-btn nt-view-btn" title="My Home"><i class="fa fa-2x fa-home"></i><span class="visuallyhidden">Homepage</span></div>').prependTo(rightMenu);
            }

            I.mem.add(new PouchDBMemory()); //Browser default, IndexedDB (probably)

            //I.net.add( new PouchDBMemory( ((PouchDB)=>new PouchDB('dbname', {adapter: 'memory'})) ) ); //MemDown

            I.mem.add(new PouchDBMemory(
                //"http://localhost:5984/doc"
                "http://ana:5984/doc"
            ));

            setTimeout(()=>{

                I.mem.add(new SpimeDBMemory("http://localhost:8080"));

            }, 4000);



            //new CesiumView().build({}, D().appendTo('#view').attr('style', 'width: 30%; float: left'));
//            new SpaceGraphView().build({}, D().appendTo('#view').attr('style', 'width: 30%; float: left'));
//            new TableView().build(I, VIEW).query("sseehh")

            const VIEW = $('#view');

            new Prompt(I, $('#find'));





            //new CesiumView().build(I, VIEW);
            new SpaceGraphView().build(I, VIEW);
        });
    });

    /** manages the state of an input text prompt and its related pop-ups */
    class Prompt {


        constructor(I, ele) {
            this.ele = ele;

            const sugg = D(); //suggestions popup
            sugg.attr('style', 'position: fixed; overflow-y: auto; min-width: 25%;min-height: 5em; margin: 0.5em; padding: 0.5em; max-height: 10em;max-width: 50%;opacity: 0.9;line-height: 1em;background-color: rgba(153, 153, 153, 0.55);');
            sugg.attr('class', 'grid');
            //sugg.attr('data-packery','{ "itemSelector": ".grid-item", "gutter": 10 }');
            sugg.hide();
            this.sugg = sugg;

            const suggFeed = D();
            suggFeed.attr('style', 'width: 100%;');
            suggFeed.packery({
                itemSelector: '.grid-item',
                gutter: 5
            });


            let queryMinUpdatePeriodMS = 100;
            const onQueryTextChanged = _.throttle(() => {

                const q = ele.val();

                suggFeed.html('');
                if (q.length) {
                    sugg.show();
                } else {
                    sugg.hide();
                }

                const update = _.debounce(()=>suggFeed.packery( 'appended' ), 100);

                I.mem.get(q, (x)=>{

                    const y = new NIcon(x).ele;

                    suggFeed.append(y);
                    update();
                });

                //$('#query_status').html('Suggesting: ' + qText);

//                $.get('/suggest', {q: qText}, function (result) {
//
//                    if (!result.length) {
//                        suggestions.html('');
//                    } else {
//                        suggestions.html(_.map((result), (x) =>
//                            D('suggestion').text(x).click(() => {
//                                ele.val(x);
//                                update(x);
//                            })
//                        ));
//                    }
//                });
            }, queryMinUpdatePeriodMS, true, true);

            const querySubmit = () => {
                var q = ele.val();
                if (q = q.trim()) {
                    //update(q);
                    I.info("share: " + q);

                    I.mem.put({
                        I: 'x' + parseInt(10000000 * Math.random()), //TODO UUID
                        N: q
                    });
                }
            };

            ele.on('input', onQueryTextChanged);

            ele.on('keypress', (e) => {
                let keyCode = e.keyCode;
                switch (keyCode) {
                    case 13: /* enter */ querySubmit(); break;
                    case 27: /* escape */ ele.val(''); /* clear */ break;
                }
            });

            ele.after(sugg);
            suggFeed.appendTo(sugg);

        }

    }

    //class DemoView  //TODO

</script>
<link type="text/css" rel="stylesheet" href="/css/normalize.css">
<link type="text/css" rel="stylesheet" href="/css/font-awesome.min.css">
<link type="text/css" rel="stylesheet" href="/lib/pnotify.custom.min.css">

<link type="text/css" rel="stylesheet" href="/css/netention.css">
<link type="text/css" rel="stylesheet" href="/css/netention-theme.css">
<style>

    .grid-item {
        border: 1px solid purple;
        margin: 2px;
        padding: 2px;
    }

    .grid-item:hover {
        border-color: white;
        cursor: move;
    }

    .cesium-widget-credits {
        display: none
    }

</style>

<body>
<!--[if lt IE 8]>
<p class="browserupgrade"><strong>Upgrade</strong> browser <a href="http://browsehappy.com/">to improve
</a> experience.</p>
<![endif]-->

<!-- MAIN VIEWPORT -->
<div id="view">
    <div id="loading">LOADING</div>
</div>

<!--<div id="overlay">-->

<!--</div>-->


<!-- MAIN MENU -->
<div id="nt-view-menu">
    <span class="nt-btn-grp">
        <input id="find" type="search"/>
    </span>
</div>


<div id="nt-right-menu">
    <div class="nt-btn-grp">
        <!-- AVATAR / MENU TOGGLE BUTTON -->
        <div id="nt-user" class="nt-btn nt-view-btn">
            <img src="/img/netention-256.png" alt="User.Icon">
        </div>
    </div>
</div>

<nav class='right animated bounceInDown'>
    <ul>
        <li>
            <a href='#profile'>
                <div class='fa fa-user'></div>
                Profile
            </a>
        </li>
        <li>
            <a href='#message'>
                <div class='fa fa-envelope'></div>
                Messages
                <span class='badge right'>12</span>
            </a>
        </li>
        <li class='sub-menu'>
            <a href='#settings'>
                <div class='fa fa-gear'></div>
                Settings
                <div class='fa fa-caret-down right'></div>
            </a>
            <ul>
                <li>
                    <a href='#settings'>
                        Account
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Profile
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Secruity &amp; Privacy
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Password
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Notification
                    </a>
                </li>
            </ul>
        </li>
        <li class='sub-menu'>
            <a href='#message'>
                <div class='fa fa-question-circle'></div>
                Help
                <div class='fa fa-caret-down right'></div>
            </a>
            <ul>
                <li>
                    <a href='#settings'>
                        FAQ's
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Submit a Ticket
                    </a>
                </li>
                <li>
                    <a href='#settings'>
                        Network Status
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <a href='#message'>
                <div class='fa fa-sign-out'></div>
                Logout
            </a>
        </li>
    </ul>
</nav>


</body>
</html>
